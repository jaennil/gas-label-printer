<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>–°–∫–∞–Ω–µ—Ä —ç—Ç–∏–∫–µ—Ç–æ–∫</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, sans-serif; background: #f0f2f5; min-height: 100vh; }

    .header {
      background: #1a73e8;
      color: white;
      padding: 16px;
      text-align: center;
      font-size: 18px;
      font-weight: 600;
    }

    .container { padding: 16px; max-width: 480px; margin: 0 auto; }

    #scanner-box {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 16px;
    }

    #reader { width: 100%; }
    #reader video { width: 100% !important; }
    #reader img   { display: none !important; }

    .scan-hint {
      text-align: center;
      padding: 10px;
      color: #666;
      font-size: 14px;
    }

    #product-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 16px;
      display: none;
    }

    .product-name    { font-size: 16px; font-weight: 600; color: #1a1a1a; line-height: 1.4; margin-bottom: 8px; }
    .product-meta    { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; }
    .product-price   { font-size: 28px; font-weight: 700; color: #1a73e8; }
    .product-article { font-size: 13px; color: #999; }
    .product-gtin    { font-size: 12px; color: #bbb; margin-top: 4px; }

    .btn-print {
      width: 100%; padding: 16px;
      background: #1a73e8; color: white;
      border: none; border-radius: 12px;
      font-size: 18px; font-weight: 600;
      cursor: pointer; margin-bottom: 10px;
    }

    .btn-scan-again {
      width: 100%; padding: 12px;
      background: white; color: #1a73e8;
      border: 2px solid #1a73e8; border-radius: 12px;
      font-size: 16px; font-weight: 600; cursor: pointer;
    }

    #error-card {
      background: #fff3f3; border: 1px solid #ffcccc;
      border-radius: 12px; padding: 20px;
      text-align: center; color: #cc0000;
      display: none; margin-bottom: 16px;
    }

    #loading {
      text-align: center; padding: 20px; color: #666; display: none;
    }

    .spinner {
      width: 36px; height: 36px;
      border: 4px solid #e0e0e0; border-top-color: #1a73e8;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    #label-canvas { display: none; }
  </style>
</head>
<body>

<div class="header">–°–∫–∞–Ω–µ—Ä —ç—Ç–∏–∫–µ—Ç–æ–∫</div>

<div class="container">
  <div id="scanner-box">
    <div id="reader"></div>
    <div class="scan-hint">–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥</div>
  </div>

  <div id="loading">
    <div class="spinner"></div>
    –ò—â–µ–º —Ç–æ–≤–∞—Ä...
  </div>

  <div id="error-card">
    <span id="error-msg">–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω</span><br>
    <small id="error-gtin" style="color:#999"></small>
  </div>

  <div id="product-card">
    <div class="product-name" id="p-name"></div>
    <div class="product-meta">
      <div>
        <div class="product-article" id="p-article"></div>
        <div class="product-gtin"   id="p-gtin"></div>
      </div>
      <div class="product-price" id="p-price"></div>
    </div>
  </div>

  <button class="btn-print"      id="btn-print"      style="display:none" onclick="printLabel()">üñ® –ü–µ—á–∞—Ç—å</button>
  <button class="btn-scan-again" id="btn-scan-again" style="display:none" onclick="scanAgain()">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
</div>

<canvas id="label-canvas"></canvas>

<script>
  // ‚Üê –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–ô URL –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è Apps Script
  const API_URL = 'https://script.google.com/macros/s/AKfycbxOHXqV7HECxBqSlSLOTfL1UJuajiDYw1hWXcug0DRMAkIZ8yKbONACX7MFj0lAmWsKJg/exec';

  let currentProduct = null;
  let scanner = null;
  let scannerRunning = false;

  // ‚îÄ‚îÄ –ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–µ—Ä–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function startScanner() {
    scanner = new Html5Qrcode("reader");
    scanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: { width: 260, height: 130 } },
      onScanSuccess
    ).then(() => {
      scannerRunning = true;
    }).catch(err => {
      document.getElementById('scanner-box').innerHTML =
        '<p style="padding:20px;color:red;text-align:center">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: ' + err + '</p>';
    });
  }

  // ‚îÄ‚îÄ –£—Å–ø–µ—à–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function onScanSuccess(decodedText) {
    if (!scannerRunning) return;
    scannerRunning = false;
    scanner.pause();
    showLoading();

    fetch(API_URL + '?gtin=' + encodeURIComponent(decodedText))
      .then(r => r.json())
      .then(onProductFound)
      .catch(err => {
        hideLoading();
        showError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err, '');
        document.getElementById('btn-scan-again').style.display = 'block';
      });
  }

  function onProductFound(product) {
    hideLoading();

    if (!product.found) {
      showError('–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω', '–ò—Å–∫–∞–ª–∏: ' + (product.searched || '‚Äî'));
      document.getElementById('btn-scan-again').style.display = 'block';
      return;
    }

    currentProduct = product;

    document.getElementById('p-name').textContent    = product.name;
    document.getElementById('p-price').textContent   = product.price + ' BYN';
    document.getElementById('p-article').textContent = '–ê—Ä—Ç. ' + product.article;
    document.getElementById('p-gtin').textContent    = 'GTIN: ' + product.gtin;

    document.getElementById('product-card').style.display   = 'block';
    document.getElementById('btn-print').style.display      = 'block';
    document.getElementById('btn-scan-again').style.display = 'block';
  }

  // ‚îÄ‚îÄ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function scanAgain() {
    currentProduct = null;
    document.getElementById('product-card').style.display   = 'none';
    document.getElementById('error-card').style.display     = 'none';
    document.getElementById('btn-print').style.display      = 'none';
    document.getElementById('btn-scan-again').style.display = 'none';
    scannerRunning = true;
    scanner.resume();
  }

  // ‚îÄ‚îÄ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —ç—Ç–∏–∫–µ—Ç–∫–∏ ‚Äî 500√ó600px (–ø–æ—Ä—Ç—Ä–µ—Ç 50√ó60–º–º) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function buildLabelCanvas(product) {
    const canvas = document.getElementById('label-canvas');
    canvas.width  = 500;
    canvas.height = 600;
    const ctx = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height;
    const pad = 50;

    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, W, H);


    // –ù–∞–∑–≤–∞–Ω–∏–µ (2 —Å—Ç—Ä–æ–∫–∏) + –∞—Ä—Ç–∏–∫—É–ª —Å–ø—Ä–∞–≤–∞
    ctx.fillStyle = '#000';
    ctx.font = 'bold 36px sans-serif';
    const nameLines = splitLines(ctx, product.name, W - pad * 2 - 90, 2);
    ctx.fillText(nameLines[0] || '', pad, 50);
    ctx.fillText(nameLines[1] || '', pad, 92);

    ctx.fillStyle = '#555';
    ctx.font = '24px sans-serif';
    ctx.textAlign = 'right';
    ctx.fillText(product.article, W - pad, 50);
    ctx.textAlign = 'left';

    // –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
    ctx.strokeStyle = '#000'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(pad, 112); ctx.lineTo(W - pad, 112); ctx.stroke();

    // –¶–µ–Ω–∞ –±–æ–ª—å—à–∞—è
    ctx.fillStyle = '#000';
    ctx.font = 'bold 130px sans-serif';
    const priceStr = String(product.price);
    ctx.fillText(priceStr, pad, 290);
    const priceW = ctx.measureText(priceStr).width;
    ctx.font = 'bold 52px sans-serif';
    ctx.fillText('—Ä—É–±', pad + priceW + 8, 290);

    // –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
    ctx.beginPath(); ctx.moveTo(pad, 320); ctx.lineTo(W - pad, 320); ctx.stroke();

    // –ò–∑–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å + —Å—Ç—Ä–∞–Ω–∞
    ctx.fillStyle = '#000';
    ctx.font = 'bold 30px sans-serif';
    ctx.fillText(product.manufacturer, pad, 370);
    ctx.textAlign = 'right';
    ctx.fillText(product.country, W - pad, 370);
    ctx.textAlign = 'left';

    ctx.strokeStyle = '#ccc'; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(pad, 395); ctx.lineTo(W - pad, 395); ctx.stroke();

    // –ò–º–ø–æ—Ä—Ç–µ—Ä
    ctx.fillStyle = '#333';
    ctx.font = '26px sans-serif';
    ctx.fillText('–ò–º–ø–æ—Ä—Ç–µ—Ä:', pad, 435);
    ctx.font = 'bold 26px sans-serif';
    ctx.fillText('–û–û–û –î–æ–º –ò–Ω—Ç–µ—Ä—å–µ—Ä–∞', pad, 468);

    return canvas;
  }

  function splitLines(ctx, text, maxWidth, maxLines) {
    const words = text.split(' ');
    const lines = [];
    let line = '';
    for (let i = 0; i < words.length; i++) {
      const test = line + (line ? ' ' : '') + words[i];
      if (ctx.measureText(test).width > maxWidth && line) {
        lines.push(line);
        if (lines.length >= maxLines) {
          let last = words.slice(i).join(' ');
          while (ctx.measureText(last + '‚Ä¶').width > maxWidth && last.length > 0)
            last = last.slice(0, -1);
          lines[lines.length - 1] = lines[lines.length - 1] + ' ' + last + '‚Ä¶';
          return lines;
        }
        line = words[i];
      } else {
        line = test;
      }
    }
    if (line) lines.push(line);
    return lines;
  }

  // ‚îÄ‚îÄ –ü–µ—á–∞—Ç—å / –®–∞—Ä–∏–Ω–≥ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function printLabel() {
    if (!currentProduct) return;
    const canvas = buildLabelCanvas(currentProduct);
    canvas.toBlob(async blob => {
      const file = new File([blob], 'label.png', { type: 'image/png' });
      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
          await navigator.share({ files: [file], title: currentProduct.name });
          return;
        } catch (e) {}
      }
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'label.png'; a.click();
      URL.revokeObjectURL(url);
    }, 'image/png');
  }

  // ‚îÄ‚îÄ –£—Ç–∏–ª–∏—Ç—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function showLoading() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('scanner-box').style.display = 'none';
  }

  function hideLoading() {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('scanner-box').style.display = 'block';
  }

  function showError(msg, sub) {
    document.getElementById('error-msg').textContent  = msg;
    document.getElementById('error-gtin').textContent = sub;
    document.getElementById('error-card').style.display = 'block';
  }

  startScanner();
</script>
</body>
</html>
